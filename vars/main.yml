---

awx_docker_compose_directory: /var/lib/awxcompose
awx_redis_socket_directory: '{{ awx_docker_compose_directory }}/redis_socket'
awx_secret_key_file_path: '{{ awx_docker_compose_directory }}/SECRET_KEY'

awx_postgres_hostname: awx-postgres
awx_postgres_port: 5432

awx_compose_project:
  - project_name: awx
    pull: yes

    definition:
      version: '3.5'
      x-logging: &default-logging
        driver: journald

      services:
        awx-redis:
          image: redis
          container_name: awx-redis
          restart: unless-stopped
          environment:
            http_proxy: "{{ awx_http_proxy | default('') }}"
            https_proxy: "{{ awx_https_proxy | default('') }}"
            no_proxy: "{{ awx_no_proxy | default('') }}"
          command: ["/usr/local/etc/redis/redis.conf"]
          volumes:
            - "{{ awx_docker_compose_dir }}/redis.conf:/usr/local/etc/redis/redis.conf:ro"
            - "{{ awx_redis_socket_directory }}:/var/run/redis/:rw"

        aws-postgres:
          container_name: awx-postgres
          image: postgres:10
          hostname: '{{ awx_postgres_hostname }}'
          volumes:
            - "{{ awx_postgres_data_dir }}/10/data/:/var/lib/postgresql/data/pgdata:Z"
          environment:
            POSTGRES_USER: "{{ awx_postgres_username }}"
            POSTGRES_PASSWORD: "{{ awx_postgres_password }}"
            POSTGRES_DB: "{{ awx_postgres_database }}"
            PGDATA: "/var/lib/postgresql/data/pgdata"
            http_proxy: "{{ awx_http_proxy | default('') }}"
            https_proxy: "{{ awx_https_proxy | default('') }}"
            no_proxy: "{{ awx_no_proxy | default('') }}"
          logging:
            << : *default-logging
            options:
              tag: awx-postgres

        awx-web:
          container_name: awx-web
          image: "{{ awx_dockerhub_base }}/awx:{{ awx_dockerhub_version }}"
          depends_on:
            - awx-redis
            - awx-postgres
            - awx-task
          ports:
            - "{{ awx_host_port }}:8052"
          hostname: awx-web
          user: root
          volumes:
            - "{{ awx_docker_compose_dir }}/SECRET_KEY:/etc/tower/SECRET_KEY"
            - "{{ awx_docker_compose_dir }}/environment.sh:/etc/tower/conf.d/environment.sh"
            - "{{ awx_docker_compose_dir }}/credentials.py:/etc/tower/conf.d/credentials.py"
            - "{{ awx_docker_compose_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
            - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
            - "{{ awx_project_data_dir }}:/var/lib/awx/projects:rw"
            - '/etc/localtime:/etc/localtime:ro'
          environment:
            http_proxy: "{{ awx_http_proxy | default('') }}"
            https_proxy: "{{ awx_https_proxy | default('') }}"
            no_proxy: "{{ awx_no_proxy | default('') }}"
          logging:
            << : *default-logging
            options:
              tag: awx-web

        awx-task:
          container_name: awx-task
          image: "{{ awx_dockerhub_base }}/awx:{{ awx_dockerhub_version }}"
          depends_on:
            - awx-redis
            - awx-postgres
          hostname: awx
          user: root
          command: /usr/bin/launch_awx_task.sh
          volumes:
            - "{{ awx_docker_compose_dir }}/SECRET_KEY:/etc/tower/SECRET_KEY"
            - "{{ awx_docker_compose_dir }}/environment.sh:/etc/tower/conf.d/environment.sh"
            - "{{ awx_docker_compose_dir }}/credentials.py:/etc/tower/conf.d/credentials.py"
            - "{{ awx_docker_compose_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
            - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
            - "{{ awx_project_data_dir }}:/var/lib/awx/projects:rw"
            - '/etc/localtime:/etc/localtime:ro'
          environment:
            http_proxy: "{{ awx_http_proxy | default('') }}"
            https_proxy: "{{ awx_https_proxy | default('') }}"
            no_proxy: "{{ awx_no_proxy | default('') }}"
          logging:
            << : *default-logging
            options:
              tag: awx-task

foreman_system_users_groups:
  - name: foreman
    uid: 998
    gid: 998
    home_dir: /usr/share/foreman
    directories:
      - name: .ssh
        mode: '0755'
        files:
          - content: '{{ foreman_user_ssh_key_data }}'
            dest: id_rsa
            mode: '0600'
          - content: '{{ foreman_user_ssh_public_key_data }}'
            dest: id_rsa.pub
            mode: '0644'
  - name: foreman-proxy
    uid: 997
    gid: 997
    home_dir: /usr/share/foreman-proxy
    directories:
      - name: .ssh
        mode: '0755'
        files:
          - content: '{{ foreman_proxy_ssh_key_data }}'
            dest: id_rsa_foreman_proxy
            mode: '0600'
          - content: '{{ foreman_proxy_ssh_public_key_data }}'
            dest: id_rsa_foreman_proxy.pub
            mode: '0644'

foreman_base_options:
  - enable-foreman-cli-ansible
  - enable-foreman-cli-discovery
  - enable-foreman-plugin-ansible
  - enable-foreman-plugin-discovery
  - enable-foreman-proxy-plugin-ansible
  - enable-foreman-proxy-plugin-discovery
  - 'foreman-initial-admin-username={{ foreman_username }}'
  - 'foreman-initial-admin-password={{ foreman_password }}'

foreman_options: |-
  {{
    foreman_base_options
      + (['enable-foreman-compute-'] | product(foreman_compute_plugins) | map('join') | list)
  }}
